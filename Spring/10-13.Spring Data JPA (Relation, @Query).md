# Relation, @Query
> Java로 RDB를 사용하기 위한 ORM이 완성되기 위해 가장 중요한 개념
* 

<hr>
<br>

## JPA를 통한 Relation 표현
#### Java로만 RDBMS 기능 수행

<br>

### [1대1 관계]

* ex) Meta 정보를 담는 테이블
  * book - book_meta_info 
* 주요 @Annotation
  * @OneToOne
  * @ToString.Exclude

<br>

```java
User user = new User();
user.setName("pskim");
user.setEmail("pskim@test.com");

UserMeta userMeta = new UserMeta();
userMeta.setAccessCount(1);
userMeta.setLastAccessDate(LocalDateTime.now());

user.setUserMeta(userMeta);
userRepository.save(user);

userMeta.setUser(user);
userMetaRepository.save(userMeta);
```
* 주요 에러
  * object references an unsaved transient instance - save the transient instance before flushing 
  * FK 값을 참조할 User 테이블의 행 값이 아직 Insert가 되어 있지 않아서 발생하는 에러
  * CASCADE 설정 필요

<br>

### [1대N 관계]
* ex) 

<br>

### [N대1 관계]
* ex) 

<br>

### [N대N 관계]
* ex) 

<br>

### [관련 추가 내용]
* 단방향 관계
  * 맴버 변수가 한 개의 값
    * @ManyToOne : (N : 1)
    * 관계의 주인 & Foreign Key 생성
  * 맴버 변수가 Collections 
    * @OneToMany : (1 : N)
    * Relation 용도 Table 생성

* 양뱡향 관계 
  * @ManyToOne 선언
    * 관계의 주인 & Foreign Key 생성
    * 관계 생성 시, 관계 쪽에는 데이터를 꼭 주입해줘야 함
    * 관계 삭제 시, null 주입
  * @OneToMany 선언
    * mappedBy 값을 같이 넣어줘야 한다
    * 관계 생성 시, 데이터를 꼭 주입해줄 필요 없다 (Optional)
    * 관계 삭제 시, remove

* @JoinColumn : FK

<br>
<hr>
<br>

## @Query
#### Native Query도 사용 가능

<br>

### [User-defined Query Method 생성]
```java
public demoRepository extends JpaRepository<Comment, Long> {
    @Query("SELECT c FROM Comment c where c.id = :id")
    List<Comment> findCommentById(@Param("id") Long id);

    // 혹은 
    @Query(value="SELECT * FROM Comment c where c.id = :id", nativeQuery = true)
    List<Comment> findCommentById(@Param("id") Long id);
}
```
* JPQL 방식
  * `SELECT Entity명`
* Native SQL 방식 
  * `SELECT *`

<br>
<hr>
<br>

##
####

<br>

### [Entity 상태 전이]
* transient
* persistent
* detached
* removed
* CascadeType.* 

<br>
<hr>
<br>
