# ChunkOrientedTasklet
> Transaction 별 수행
* 

<hr>
<br>

## 기본 개념
#### 

<br>

### [ChunkOrientedTasklet]
* Chunk 지향 프로세싱을 위한 Tasklet 구현체
  * Chunk의 사이즈가 Commit Interval
* 수행 시, 새로운 트랜잭션 시작
  * exception 발생 시, 해당 Chunk만 롤백, 커밋된 Chunk는 유지
* 구성
  * ChunkProvider
    * ItemReader (Item별 개별 처리)
  * ChunkProcessor
    * ItemProcessor (Item별 개별 처리)
    * ItemWriter (Chunk별 개별 처리)
```java
StepBuilderFactory.get()
                  .<I, O> chunk()
                  .reader()
                  .processor()
                  .writer()
                  .stream()
                  .readerIsTransactionalQueue()
                  .listener()
```

<br>

### [ItemReader]
* item 한 건을 읽어서 item 한 건을 리턴하여 Chunk 하나를 만든다 
* 대상
  * Flat한 파일 (txt, csv)
  * Database
  * xml
  * Queue (rabbitMQ, kafka 등등)

<br>

### [ItemWriter]
* Chunk 하나를 받아서 일괄처리로 write한다

<br>
<hr>
<br>

## Scope
#### 보통, 스프링 컨테이너에서 빈이 관리되는 범위

<br>

### [@JobScope, @StepScope]
* Job과 Step의 빈 생성과 실행에 관한 Scope
* @Scope(value = "job", proxyMode=ScopedProxyMode.TARGET_CLASS)
  * 어플리케이션 구동 시점이 아닌, 빈 실행 시점에 빈이 생성된다
  * 즉, @Values를 통한 값 주입을 어플리케이션 구동 시점이 아니라, 빈 실행 시점에 할 수 있기 때문에, 어플리케이션 구동할 때 1번이 아니라, 동적으로 런타임 때 값을 주입할 수 있게 된다 (`Lazy Binding`)
  * ex) `@Value("#{jobParameters[파라미터명]}")`, `@Value("#{jobExecutionContext[파라미터명]}")`, `@Value("#{stepExecutionContext[파라미터명]}")`
* ProxyMode로 빈이 선언되기 때문에, 어플리케이션 `구동시점`에 빈의 프록시 객체가 생성되어 `실행시점`에 실제 빈을 호출한다
* 병렬처리 시, 각 쓰레드마다 생성된 스코프 빈이 할당되기 때문에, ThreadSafe하다
* 선언 위치
  * `@JobScope`
    * 위치 : Step 선언문
    * @Value : jobParameter, jobExecutionContext
  * `@StepScope`
    * 위치 : Tasklet, ItemReader, ItemWriter, ItemProcessor
    * @Value : jobParameter, jobExecutionContext, stepExecutionContext
   
<br>

### 아키텍쳐
* Proxy 객체 생성
  * @JobScope, @StepScope 가 붙은 빈 선언은 내부적으로 빈의 Proxy 객체가 생성
    * @JobScope : @Scope(value = "job", proxyMode = ScopedProxyMode.TARGET_CLASS)
    * @StepScope : @Scope(value = "step", proxyMode = ScopedProxyMode.TARGET_CLASS)

<div align="center">
  <img width="80%" src="https://github.com/PoSungKim/development_study/assets/37537227/0342a126-114e-446b-af2a-2da4ec573c05">
</div>
    
* Job 실행 시 Proxy 객체가 실제 빈을 호출하여 해당 메서드를 실행 --> AOP
  * ApplicationContext처럼, JobContext 및 StepContext 존재
* JobContext, StepContext
  * Job의 실행 시점에서 프록시 객체가 실제 빈을 참조할 때 사용
* 주요 객체
  * ScopeConfiguration
  * JdkDynamicAopProxy

<br>
<hr>
<br>
