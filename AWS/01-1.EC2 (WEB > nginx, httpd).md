# EC2 (WEB > nginx, httpd)
> WEB 서버로 React 구동
* Apache HTTPD, Nginx 모두 가능

<hr>
<br>

## Nginx 구축 [:80]
#### Async, Event-driven

<br>

### [WEB 서버 설치 및 실행]
```bash
# $releasever 확인
uname -a
uname -r
cat /etc/os-release
```

```bash
# yum repository에 Nginx 추가
sudo vi /etc/yum.repos.d/nginx.repo # add NGINX yum repository

[nginx]
name=nginx repo
baseurl=https://nginx.org/packages/centos/5/$basearch/
gpgcheck=0
enabled=1
```

```bash
# yum repository에서 nginx 정보 확인
yum info nginx

Failed to set locale, defaulting to C
Loaded plugins: extras_suggestions, langpacks, priorities, update-motd
amzn2-core                                                                                                                                                                           | 3.7 kB  00:00:00
nginx                                                                                                                                                                                | 2.5 kB  00:00:00
nginx/x86_64/primary_db                                                                                                                                                              |  20 kB  00:00:01
Available Packages
Name        : nginx
Arch        : x86_64
Version     : 1.10.3
Release     : 1.el5.ngx
Size        : 965 k
Repo        : nginx/x86_64
Summary     : High performance web server
URL         : http://nginx.org/
License     : 2-clause BSD-like license
Description : nginx [engine x] is an HTTP and reverse proxy server, as well as
            : a mail proxy server.
```

```bash
# Nginx 설치
sudo yum install nginx

sudo amazon-linux-extras install nginx1 #AWS EC2 환경
```

```bash
# Nginx 버전 확인
nginx -v

nginx version: nginx/1.20.0 #2022.06.09 기준
```

```bash
# Nginx 실행/재실행/중지
sudo service nginx start
sudo service nginx restart
sudo service nginx stop
```

```bash
# Nginx 상태 확인
sudo systemctl status nginx

ps -ef | grep nginx
```

<br>

### [세부 설정 - [Beginners' Guide](https://nginx.org/en/docs/beginners_guide.html)]
```bash
# conf 파일 찾기
sudo find / -name nginx.conf

/etc/nginx/nginx.conf

vi /etc/nginx/nginx.conf

user ${matching_name};
```

<br>

```bash
# default 세팅 생성
sudo vi /etc/nginx/conf.d/default.conf

server {
        listen 80;
        location / {
                root /home/benebean/front;
                index index.html;
                try_files $uri $uri/ /index.html;
        }
}
```
* location : 해당 디렉토리를 포함하는 모든 Request를 root로 설정된 곳에서 찾도록 설정
* React의 SPA 특징을 활용하기 위해서는 추가 설정 필요
  * react-router를 사용하기 위해서는 모든 Request가 index.html를 향하게 설정

<br>

### [HTTPS 설정]

```conf
server {
        listen 80;
        server_name benebean-lightbulb.com;
        location / {
                root /home/benebean/front;
                index index.html;
                try_files $uri $uri/ /index.html;
        }
}

server {
        listen 443;
        server_name benebean-lightbulb.com;
        location / {
                root /home/benebean/front;
                index index.html;
                try_files $uri $uri/ /index.html;
        }
}
```
* 기본적인 443 설정을 진행하지 않으면 `sudo certbot --nginx` 명령어에서 에러 발생

<br>

```bash
# EPEL (Extra Packages for Enterprise Linux) 존재 여부 확인 > 없으면, 설치 진행
yum repolist 

sudo yum install https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm
rpm -qa epel-release

sudo yum install certbot
sudo yum install certbot-nginx

sudo certbot --nginx 
```
* `sudo certbot --nginx ` 명령어에 대한 CLI 안내에 따라 내용을 기입하면 자동으로 default.conf 파일과 ssl 설정에 필요한 .pem 파일들을 설정해줌

<br>

```conf
server {
	server_name benebean-lightbulb.com;
	location / {
		root /home/benebean/front;
		index index.html;
		try_files $uri $uri/ /index.html;
	}

    listen 443 ssl; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/benebean-lightbulb.com/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/benebean-lightbulb.com/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot

}

server {
	listen 443;
	server_name benebean-lightbulb.com;
	location / {
		root /home/benebean/front;
		index index.html;
		try_files $uri $uri/ /index.html;
	}
	# ssl_certificate benebean-lightbulb.crt;
}
server {
    if ($host = benebean-lightbulb.com) {
        return 301 https://$host$request_uri;
    } # managed by Certbot


	listen 80;
	server_name benebean-lightbulb.com;
    return 404; # managed by Certbot


}
```
* 자동으로 .conf 파일이 파싱되어 설정 완료됌

<br>
<hr>
<br>

## Apache HTTPD 구축 [:80]
#### Thread-programming

<br>

### [WEB 서버 설치 및 실행]
```bash
sudo yum install httpd -y
sudo service httpd start &

ps -ef | grep httpd
```

<br>

### [WEB 서버 HTML/CSS/JS 구축]
```bash
cd /var/www/html
scp -i ${pemDir} ${localDir} {ec2Dir}

sudo scp -r -i "Data_Engineering_Seoul.pem" /Users/posungkim/Desktop/Portfolio/git/chatbot_react/public/* ec2-user@ec2-13-124-198-75.ap-northeast-2.compute.amazonaws.com:/var/www/html

aws s3 cp s3://data-engineering-fintech/WEB/ /var/www/html/ --recursive
```

<br>
<hr>
<br>
