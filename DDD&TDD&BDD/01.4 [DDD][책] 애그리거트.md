# ì• ê·¸ë¦¬ê±°íŠ¸
> 1 Aggregate = 1 Domain Model
* 

<hr>
<br>

## ì• ê·¸ë¦¬ê±°íŠ¸
#### ê´€ë ¨ëœ ê°ì²´ë¥¼ í•˜ë‚˜ì˜ êµ°ìœ¼ë¡œ...

<br>

### ì• ê·¸ë¦¬ê±°íŠ¸
* ê´€ë ¨ëœ ê°ì²´ë¥¼ í•˜ë‚˜ì˜ êµ°ìœ¼ë¡œ ë¬¶ì–´ ì¤Œ
  * ê°™ê±°ë‚˜ ë¹„ìŠ·í•œ ë¼ì´í”„ì‹¸ì´í´ì„ ê°–ëŠ”ë‹¤ (ex : Order-OrderLine)
  * ë³„ë„ì˜ ë¼ì´í”„ì‹¸ì´í´ì„ ê°–ëŠ” ê´€ê³„ì—ì„œëŠ” ì„œë¡œ ë‹¤ë¥¸ ì• ê·¸ë¦¬ê±°íŠ¸ê°€ ëœë‹¤ (ex : ìƒí’ˆ-ë¦¬ë·°)
* ìƒìœ„ ìˆ˜ì¤€ì—ì„œ ë„ë©”ì¸ ëª¨ë¸ ê°„ì˜ ê´€ê³„ íŒŒì•… ê°€ëŠ¥! ì‘ì€ ê·¸ë¦¼ë§Œ íŒŒì•…í•´ì„œëŠ” ìš”êµ¬ì‚¬í•­ì— ëŒ€í•´ì„œ ì½”ë“œ ìˆ˜ì •ì„ ìµœì†Œí•œìœ¼ë¡œ í•˜ëŠ” í˜‘ì˜ë¡œë§Œ ê°ˆ ìˆ˜ë°–ì— ì—†ìŒ!
* ì• ê·¸ë¦¬ê±°íŠ¸ì˜ ê²½ê³„ ì„¤ì •ì˜ ê¸°ë³¸
  * `ë„ë©”ì¸ ê·œì¹™`
  * `ìš”êµ¬ì‚¬í•­`
* Example
```markdown
- ì£¼ë¬¸
  âŒ Order
  âŒ Orderer
  âŒ Shipping Info
  âŒ Receiver
  âŒ Address
  âŒ Delivery Tracking 
  âŒ OrderLine 
- ê²°ì œ
  âŒ Payment Info
- ë¶„ë¥˜
  âŒ Category
- ìƒí’ˆ
  âŒ Product
- ë¦¬ë·°
  âŒ Review
- íšŒì›
  âŒ Member
  âŒ Member Grade
```
* ì£¼ë¬¸ (Order)ê°€ ì¢‹ì€ ì˜ˆì‹œì¸ë°, `í•¨ê»˜ ìƒì„±`ë˜ê³  `í•¨ê»˜ ë³€ê²½`ë˜ë©´ ê°™ì€ ì• ê·¸ë¦¬ê±°íŠ¸ì— ì†í•  í™•ë¥ ì´ ë†’ë‹¤
  * `Order`ì™€ `OrderLine`ì˜ ê´€ê³„ì²˜ëŸ¼
  * `Order`ì™€ `Orderer ë° ShippingInfo`ì˜ ê´€ê³„ì²˜ëŸ¼
* ìƒí’ˆ (Product)ì™€ ë¦¬ë·° (Review)ëŠ” ë‹¤ë¥¸ ì• ê·¸ë¦¬ê±°íŠ¸

<br>

## ì• ê·¸ë¦¬ê±°íŠ¸ ë£¨íŠ¸
#### ë˜ê·¸ë¦¬ê±°íŠ¸ ì „ì²´ë¥¼ ê´€ë¦¬í•  ì£¼ì²´

<br>

### ì• ê·¸ë¦¬ê±°íŠ¸ ë£¨íŠ¸
* `ì£¼ë¬¸ ì• ê·¸ë¦¬ê±°íŠ¸` êµ¬ì„± ì—”í‹°í‹°
  * ì´ ê¸ˆì•¡ì¸ totalAmountsë¥¼ ê°–ê³  ìˆëŠ” Order ì—”í‹°í‹°
  * ê°œë³„ êµ¬ë§¤ ìƒí’ˆì˜ ê°œìˆ˜ì¸ quantityì™€ ê¸ˆì•¡ì¸ priceë¥¼ ê°–ê³  ìˆëŠ” OrderLine ë°¸ë¥˜
* `ë„ë©”ì¸ ê·œì¹™`
  * ì£¼ë¬¸ ì´ ê¸ˆì•¡ = ê°œë³„ ìƒí’ˆì˜ ì£¼ë¬¸ ê°œìˆ˜ * ê°€ê²©ì˜ í•©
* ì• ê·¸ë¦¬ê±°íŠ¸ ë£¨íŠ¸
  * ë˜ê·¸ë¦¬ê±°íŠ¸ ì „ì²´ë¥¼ ê´€ë¦¬í•  ì£¼ì²´ë¡œ, ì• ê·¸ë¦¬ê±°íŠ¸ì— ì†í•œ ëª¨ë“  ê°ì²´ê°€ ì •ìƒ ìƒíƒœì„ì„ ê´€ë¦¬

<br>

### ë„ë©”ì¸ ê·œì¹™ê³¼ ì¼ê´€ì„±
* ì£¼ë¬¸ ì• ê·¸ë¦¬ê±°íŠ¸ëŠ” `ë°°ì†¡ì§€ ë³€ê²½`, `ìƒí’ˆ ë³€ê²½` ë“±ì˜ ê¸°ëŠ¥ì„ ì œê³µ
  * ì• ê·¸ë¦¬ê±°íŠ¸ ë£¨íŠ¸ì¸ `Order`ê°€ ê¸°ëŠ¥ì„ êµ¬í˜„í•œ ë©”ì†Œë“œ ì œê³µ

```java
public class Order {
    
    private ShippingInfo shippingInfo;
    
    // ì• ê·¸ë¦¬ê±°íŠ¸ ë£¨íŠ¸ëŠ” ë„ë©”ì¸ ê·œì¹™ì„ êµ¬í˜„í•œ ê¸°ëŠ¥ì„ ì œê³µ
    public void changeShippingInfo(ShippingInfo newShippingInfo) {
        verifyNotYetShipped();
        setShippingInfo(newShippingInfo);
    }
    
    private void verifyNotYetSipped() {
        if (state != OrderState.PAYMENT_WAITING && state != OrderState.PREPARING)
            throw new IllegalStateEception("already shipped");
    }
    
    // set ë©”ì†Œë“œì˜ ì ‘ê·¼ í—ˆìš© ë²”ìœ„ëŠ” privateì´ë‹¤
    private void setShippingInfo(ShippingInfo newShippingInfo) {
        // ë°¸ë¥˜ê°€ ë¶ˆë³€ì´ë©´ ìƒˆë¡œìš´ ê°ì²´ë¥¼ í• ë‹¹í•´ì„œ ê°’ì„ ë³€ê²½í•´ì•¼ í•œë‹¤.
        // ë¶ˆë³€ì´ë¯€ë¡œ this.shippingInfo.setAddress(newShippingInfo.getAddress())ì™€ ê°™ì€ ì½”ë“œë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ë‹¤.
        this.shippingInfo = newShippingInfo;
    }
}
```
* `ë„ë©”ì¸ ê·œì¹™` (ë°°ì†¡ì§€ ë³€ê²½ ê¸°ëŠ¥)
  * `ë°°ì†¡ì´ ì‹œì‘ë˜ê¸° ì „ê¹Œì§€ë§Œ ë°°ì†¡ì§€ ì •ë³´ë¥¼ ë³€ê²½í•  ìˆ˜ ìˆë‹¤`
* ì• ê·¸ë¦¬ê±°íŠ¸ ì™¸ë¶€ì—ì„œ ì• ê·¸ë¦¬ê±°íŠ¸ì— ì†í•œ ê°ì²´ë¥¼ ì§ì ‘ ë³€ê²½í•˜ë©´ ì•ˆ ëœë‹¤
  * ë”°ë¼ì„œ, ì• ê·¸ë¦¬ê±°íŠ¸ ë£¨íŠ¸ë¥¼ í†µí•´ì„œë§Œ ë„ë©”ì¸ ë¡œì§ì„ êµ¬í˜„
    * ë‹¨ìˆœíˆ í•„ë“œë¥¼ ë³€ê²½í•˜ëŠ” set ë©”ì†Œë“œë¥¼ ê³µê°œ(public) ë²”ìœ„ë¡œ ë§Œë“¤ì§€ ì•ŠëŠ”ë‹¤
    * ë°¸ë¥˜ íƒ€ì…ì€ ë¶ˆë³€ìœ¼ë¡œ êµ¬í˜„í•œë‹¤
* ë°¸ë¥˜ íƒ€ì…ì˜ ë‚´ë¶€ ìƒíƒœë¥¼ ë³€ê²½í•˜ë ¤ë©´ `ì• ê·¸ë¦¬ê±°íŠ¸ ë£¨íŠ¸`ë¥¼ í†µí•´ì„œë§Œ ê°€ëŠ¥
  * ì• ê·¸ë¦¬ê±°íŠ¸ ë£¨íŠ¸ê°€ ë„ë©”ì¸ ê·œì¹™ì„ ì˜¬ë°”ë¥´ê²Œë§Œ êµ¬í˜„í•˜ë©´ ì• ê·¸ë¦¬ê±°íŠ¸ ì „ì²´ì˜ ì¼ê´€ì„±ì„ ì˜¬ë°”ë¥´ê²Œ ìœ ì§€ ê°€ëŠ¥

<br>

### ì• ê·¸ë¦¬ê±°íŠ¸ ë£¨íŠ¸ì™€ ì—­í• 
* ì• ê·¸ë¦¬ê±°íŠ¸ ë£¨íŠ¸ëŠ” ì• ê·¸ë¦¬ê±°íŠ¸ ë‚´ë¶€ì˜ ë‹¤ë¥¸ ê°ì²´ë¥¼ ì¡°í•©í•´ì„œ ê¸°ëŠ¥ ì™„ì„±

<br>

### ì• ê·¸ë¦¬ê±°íŠ¸ ë£¨íŠ¸ì™€ ì—­í•  Example (1) GOOD ğŸ‘
```java
public class Order {
    private Money totalAmounts;
    private List<OrderLine> orderLines;
    
    private void calculateTotalAmounts() {
        int sum = orderLines.stream()
                            .mapToInt(ol -> ol.getPrice() * ol.getQuantity())
                            .sum();
                            
        this.totalAmounts = new Money(sum);
    }
}
```

```java
public class Member {
    private Password password;
    
    public void changePassword(String currentPassword, String newPassword) {
        if (!password.match(currentPassword) {
            throw new PAsswordNotMatchException();
        }
    }
    this.password = new Password(newPassword);
}
```

### ì• ê·¸ë¦¬ê±°íŠ¸ ë£¨íŠ¸ì™€ ì—­í•  Example (2) GOOD ğŸ‘
```java
public class OrderLine {
    private List<OrderLine> lines;
    
    public Money getTotalAmounts() {
        // êµ¬í˜„
    }
    
    public void changeOrderLines(List<OrderLine> newLines) {
        this.lines = newLines;
    }
}
```

```java
public class Order { 
    private Money totalAmounts;
    private OrderLines orderLines;
    
    public void changeOrderLines(List<OrderLine> newLines) {
        orderLines.changeOrderLines(newLines);
        this.totalAmounts = orderLines.getTotalAmounts();
    }
}
```

### ì• ê·¸ë¦¬ê±°íŠ¸ ë£¨íŠ¸ì™€ ì—­í•  Example (3) BAD ğŸ‘
```java
OrderLines lines = order.getOrderLines();
lines.changeOrderLines(newOrderLines);
```
* ì£¼ë¬¸ì˜ OrderLineì´ ë°”ë€ŒëŠ”ë° ì´í•©ì€ ê³„ì‚°í•˜ì§€ ì•ŠëŠ” ë²„ê·¸ë¥¼ ì•¼ê¸°
* í•´ê²°ì•ˆ) ì™¸ë¶€ì—ì„œ OrderLine ëª©ë¡ì„ ë³€ê²½í•˜ì§€ ëª»í•˜ë„ë¡ í•¨
  * íŒ¨í‚¤ì§€ë‚˜ protected ë²”ìœ„ ì‚¬ìš©

<br>

### íŠ¸ë Œì ì…˜ ë²”ìœ„
* í•˜ë‚˜ì˜ Transactionì—ëŠ” í•˜ë‚˜ì˜ Aggregateë§Œ ìˆ˜ì •

<br>

### íŠ¸ë Œì ì…˜ ë²”ìœ„ Example (1) BAD ğŸ‘
```java
public class Order {
    private Orderer orderer;
    
    public void shipTo(ShippingInfo, newShippingInfo, boolean useNewShippingAddrAsMemberAddr) {
        verifyNotYetShipped();
        setShippingInfo(newShippingInfo);
        
        if (useNewShippingAddrAsMemberAddr) {
            // ë‹¤ë¥¸ ì• ê·¸ë¦¬ê±°íŠ¸ì˜ ìƒíƒœë¥¼ ë³€ê²½í•˜ë©´ ì•ˆ ë¨!
            orderer.getMember().changeAddress(newShippinigInfo.getAddress());
        }
    }
}
```
* í•˜ë‚˜ì˜ AggregateëŠ” ë‹¤ë¥¸ Aggregateë¥¼ ìˆ˜ì •í•´ì„œëŠ” ì•ˆëœë‹¤
  * Aggregate ê°„ì˜ ê²°í•©ë„ëŠ” ìµœëŒ€í•œ ë‚®ì¶°ì•¼ í•œë‹¤

<br>

### íŠ¸ë Œì ì…˜ ë²”ìœ„ Example (2) GOOD ğŸ‘

```java
public class ChangeOrderService {
    // ë‘ ê°œ ì´ìƒì˜ ì• ê·¸ë¦¬ê±°íŠ¸ë¥¼ ë³€ê²½í•´ì•¼ í•˜ë©´,
    // ì‘ìš© ì„œë¹„ìŠ¤ì—ì„œ ê° ì• ê·¸ë¦¬ê±°íŠ¸ì˜ ìƒíƒœë¥¼ ë³€ê²½
    @Transactional
    public void changeShippingInfo(OrderId, id, ShippingInfo newShippingInfo, boolean useNewShippingAddrAsMemberAddr) {
        Order order = orderRepository.findbyId(id);
        if (order == null) throw new OrderNotFoundException();
        order.shipTo(newShippingInfo);
        
        if (useNewShippingAsMemberAddr) {
            Member member = findMemeber(order.getOrderer());
            member.changeAddress(newShippingInfo.getAddress());
        }
    }
}
```
* ë¶ˆê°€íŒŒí•˜ê²Œ ë‹¤ìˆ˜ì˜ ì• ê·¸ëŸ¬ê±°íŠ¸ë¥¼ ìˆ˜ì •í•´ì•¼ í•œë‹¤ë©´, `ì‘ìš© ì„œë¹„ìŠ¤`ì—ì„œ ìˆ˜ì •í•œë‹¤

<br>

### ì• ê·¸ë¦¬ê±°íŠ¸ì™€ ë¦¬í¬ì§€í† ë¦¬
* 1 Aggreate --> 1 Repository

```java
// ë¦¬í¬ì§€í„°ë¦¬ì— ì• ê·¸ëŸ¬ê±°íŠ¸ë¥¼ ì €ì¥í•˜ë©´ ì• ê·¸ë¦¬ê±°íŠ¸ ì „ì²´ë¥¼ ì˜ì†í™”í•´ì•¼ í•œë‹¤.
orderRepository.save(order);

// ë¦¬í¬ì§€í„°ë¦¬ëŠ” ì™„ì „í•œ orderë¥¼ ì œê³µí•´ì•¼ í•œë‹¤
Order order = orderRepository.findById(orderId);

// orderê°€ ì˜¨ì „í•œ ì• ê·¸ë¦¬ê±°íŠ¸ê°€ ì•„ë‹ˆë©´
// NullPointerExceptionê³¼ ê°™ì€ ë¬¸ì œê°€ ë°œìƒí•œë‹¤
order.cancel();
```

<br>

### IDë¥¼ ì´ìš©í•œ ì• ê·¸ë¦¬ê±°íŠ¸ ì°¸ì¡°
```java
order.getOrderer().getMember().getId();
```
* JPAë¥¼ í†µí•´ì„œ ì—°ê´€ ê°ì²´ë“¤ì„ ë¡œë”©í•˜ëŠ” ê¸°ëŠ¥ ì œê³µë°›ì„ìˆ˜ ìˆìŒ
  * `@ManyToOne`
  * `@OneToOne`
* ë‹¤ë§Œ, ì´ëŸ¬í•œ í¸ë¦¬í•œ ê¸°ëŠ¥ì€ ì˜¤ìš©ìœ¼ë¡œ ì´ì–´ì§ˆ ìˆ˜ ìˆìŒ

### IDë¥¼ ì´ìš©í•œ ì• ê·¸ë¦¬ê±°íŠ¸ ì°¸ì¡° Example (1) BAD ğŸ‘
```java
public class Order {
    private Orderer orderer;
    
    public void shipTo(ShippingInfo, newShippingInfo, boolean useNewShippingAddrAsMemberAddr) {
        ...
        if (useNewShippingAddrAsMemberAddr) {
            // í•œ ì• ê·¸ë¦¬ê±°íŠ¸ ë‚´ë¶€ì—ì„œ ë‹¤ë¥¸ ì• ê·¸ë¦¬ê±°íŠ¸ì— ì ‘ê·¼í•  ìˆ˜ ìˆìœ¼ë©´,
            // êµ¬í˜„ì´ ì‰¬ì›Œì§„ë‹¤ëŠ” ê²ƒ ë•Œë¬¸ì— ë‹¤ë¥¸ ì• ê·¸ë¦¬ê±°íŠ¸ì˜ ìƒíƒœë¥¼ ë³€ê²½í•˜ëŠ” ìœ í˜¹ ì¡´ì¬
            orderer.getMember().changeAddress(newShippinigInfo.getAddress());
        }
    }
}
```
* ë¬¸ì œì  1) ë†’ì•„ì§€ëŠ” ê²°í•©ë„
* ë¬¸ì œì  2) JPAë¥¼ í†µí•œ ê°ì²´ ì§€ì—°(Lazy) ë¡œë”© ë° ì¦‰ì‹œ(Eager) ë¡œë”©, ì¦‰ íš¨ìœ¨ì ì¸ ë¡œë”© ë°œìƒ ê°€ëŠ¥
  * ì—°ê´€ ë§¤í•‘ ë° JPQL/Criteria ì¿¼ë¦¬ì˜ ë¡œë”© ì „ëµ ê²°ì • í•„ìš”
* ë¬¸ì œì  3) ë„ë©”ì¸ë³„ ë‹¤ë¥¸ DBMSë¥¼ ì‚¬ìš©í•˜ëŠ” ë“±ì˜ í™•ì¥ì— ì–´ë ¤ì›€ ë°œìƒ
  * OrderRepository   <-- JpaOrderRepository <-- Oracle
  * ProductRepository <-- MongoRepository    <-- MongoDB

```java
public class Order {
    private Orderer orderer;
    ...
}

public class Orderer {
    // private Member member;ë¡œ ì§ì ‘ ì°¸ì¡°í•˜ëŠ” ë°©ì‹ì„ ì‚¬ìš©í•˜ì§€ ì•Šê³ ,
    private MemberId memberId; // memberIdë¥¼ ì‚¬ìš©í•œë‹¤
    private String name;
    ...
}

public class Member {
    private MemberId id;
}
```

* ë”°ë¼ì„œ, ì§ì ‘ ì°¸ì¡°í•˜ëŠ” ë°©ì‹ì´ ì•„ë‹ˆë¼, Idê°’ì„ ì´ìš©í•œ ë¹„ì§ì ‘ ì°¸ì¡° í•„ìš”

```java
public class ChangeOrderService {
    @Transactional
    public void changeShippingInfo(OrderId id, ShippingInfo newShippingInfo, boolean useNewShippingAddrAsMemberAddr) {
        Order order = orderRepository.findbyId(id);
        if (order == null) throw new OrderNotFoundException();
        
        order.changeShippingInfo(newShippingInfo);
        if (useNewShippingAsMemberAddr) {
            //IDë¥¼ ì´ìš©í•˜ì—¬ ì°¸ì¡°í•˜ëŠ” ì• ê·¸ë¦¬ê±°íŠ¸ë¥¼ êµ¬í•œë‹¤
            Member member = memberRepository.findById( order.getOrderer().getMemberId() );
            member.changeAddress( newShippingInfo.getAddress() );
        }
    }
    ... 
}
```

<br>

### IDë¥¼ ì´ìš©í•œ ì°¸ì¡°ì™€ ì¡°íšŒ ì„±ëŠ¥
* ìƒí™©ì— ë”°ë¼ ì—¬ëŸ¬ ì—ê·¸ë¦¬ê±°íŠ¸ê°€ ì°¸ì¡°ëœ ì—°ì‚°ì„ ì§„í–‰í•˜ë©´ ì¡°íšŒ ì†ë„ê°€ ëŠë¦¬ë‹¤

```java
Member member        = memberRepository.findById(ordererId);
List<Order> orders   = orderRepository.findByOrderer(ordererId);
List<OrderView> dtos = orders.stream()
                             .map( order -> {
                                 ProductId prodId = order.getOrderLines().get(0).getProductId();
                                 
                                 // ê° ì£¼ë¬¸ë§ˆë‹¤ ì²« ë²ˆì§¸ ì£¼ë¬¸ ìƒí’ˆ ì •ë³´ ë¡œë”© ìœ„í•œ ì¿¼ë¦¬ ì‹¤í–‰
                                 Product product = productRepository.findById(prodId);
                                 
                                 return new OrderView(order, member, product);
                           }).collect(toList());
```
* `N + 1 ì¡°íšŒ ë¬¸ì œ`
  * ì¡°íšŒ ëŒ€ìƒì´ Nê°œì¼ ë•Œ Nê°œë¥¼ ì½ì–´ì˜¤ëŠ” í•œ ë²ˆì˜ ì¿¼ë¦¬ì™€ ì—°ê´€ëœ ë°ì´í„°ë¥¼ ì½ì–´ì˜¤ëŠ” ì¿¼ë¦¬ë¥¼ Në²ˆ ì‹¤í–‰
* í•´ê²°ì•ˆ
  * ì¦‰ì‹œ(Eager) ë¡œë”©ì´ ë˜ë„ë¡ ID ì°¸ì¡° ë°©ì‹ì—ì„œ `ê°ì²´ ì°¸ì¡° ë°©ì‹`ìœ¼ë¡œ íšŒê·€
  * ì¡°íšŒ ì „ìš© ì¿¼ë¦¬ë¡œ `JOIN` ì‚¬ìš© (MyBatis)
  * ì¡°íšŒ ì „ìš© ì¿¼ë¦¬ë¡œ `JOIN` ì‚¬ìš© (JPQL)

<br>

### IDë¥¼ ì´ìš©í•œ ì°¸ì¡°ì™€ ì¡°íšŒ ì„±ëŠ¥ (1) GOOD ğŸ‘

```java
@Repository
public class JpaOrderViewDao implements OrderViewDao {
    @PersistenceContext
    private EntityManager em;
    
    @Override
    public List<OrderView> selectByOrderer(String ordererId) {
        String selectQuery = 
            "select new com.myshop.order.application.dto.OrderView(o, m, p) " +
            "from Order o join o.orderLines ol, Member m, Product p" +
            "where o.orderer.memberId.id = :ordererId" + 
            "and o.orderer.memberId = m.id " +
            "and index(ol) = 0 " +
            "and ol.productId = p.id" +
            "order by o.number.number desc";
        TypedQuery<OrderView> query = 
            em.createQuery(selectQuery, OrderView.class);
        query.setParameter("ordererId", ordererId);
        return query.getResultList();
    }
}
```

<br>

### ì• ê·¸ë¦¬ê±°íŠ¸ ê°„ ì§‘í•© ì—°ê´€
* `1-N`, `M-N` ì—°ê´€ --> Java Collection ì´ìš©
  * ì¹´í…Œê³ ë¦¬-ìƒí’ˆ ê°„ì˜ ì—°ê´€ : `1-N` --> Set

<br>

### ì• ê·¸ë¦¬ê±°íŠ¸ ê°„ ì§‘í•© ì—°ê´€ Example (`1-N`) BAD ğŸ‘
```java
public class Category {
    private Set<Product> products; // ë‹¤ë¥¸ ì• ê·¸ë¦¬ê±°íŠ¸ì— ëŒ€í•œ 1-N ì—°ê´€

    // Bad Example) 
    public List<Product> getProducts(int page, int size) {
        List<Product> sortedProducts = sortById(products);
        return sortedProducts.subList(page - 1) * size, page * size);
    }
}
```
* ì¼ë‹¨ ëª¨ë“  productsë¥¼ ì¡°íšŒí•œ ì´í›„ì— subListë¥¼ êµ¬í•˜ëŠ” ê²ƒì´ê¸° ë•Œë¬¸ì— ì„±ëŠ¥ì´ ëŠë¦¬ë‹¤

<br>

### ì• ê·¸ë¦¬ê±°íŠ¸ ê°„ ì§‘í•© ì—°ê´€ Example (`N-1`) GOOD ğŸ‘

```java
public class Product {
    private CategoryId categoryId;
}

public class ProductListService {
    public Page<Product> getProductOfCategory(Long CategoryId, int page, int size) {
        Category category       = categoryRepository.findById(categoryId);
        checkCategory(category);
        
        List<Product> products  = productRepository.findByCategoryId(category.getId(), page, size);
        int totalCount          = productRepository.countsByCategoryId(category.getId());
        
        return new Page(page, size, totalCount, products);
    }
}
```
* `productRepository.findByCategoryId(category.getId(), page, size);`ì„ í†µí•´, ëª¨ë“  Productë¥¼ ì¡°íšŒí•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, ì²˜ìŒë¶€í„° sublistë¥¼ ê°€ì ¸ì˜¤ë‹ˆ ì„±ëŠ¥ì´ ë” ë¹ ë¥´ë‹¤

<br>

### ì• ê·¸ë¦¬ê±°íŠ¸ ê°„ ì§‘í•© ì—°ê´€ Example (`M-N`) GOOD ğŸ‘

```java
public class Product {
    private Set<CategoryId> categoryIds;
}

@Entity
@Table(name = "product")
public class Product {
    @EmbeddedId
    private ProductId id;
    
    @ElementCollection
    @CollectionTable(name = "product_category", joinColumns = @JoinColumn(name = "product_id"))
    private Set<CategoryId> categoryIds;
}

@Repository
public class JpaProductRepository implements ProductRepository {
    @PersistenceContext
    private EntityManager entityManager;
    
    @Override
    public List<Product> findByCategoryId(CategoryId catId, int page, int size) {
        TypedQuery<Product> query = entityManager.createQuery(
            "SELECT p FROM Product p " +
            "WHERE :catId member of p.categoryIds ORDER BY p.id.id desc",
            Product.class)
         ;
         
         query.setParameter("catId", catId);
         query.setFirstResult( (page - 1) * size);
         query.setMaxResults(size);
         
         return query.getResultList();
    }
}
```
* `:catId member of p.categoryIds` : categoryIds ì»¬ë ‰ì…˜ì— catIdë¡œ ì§€ì •í•œ ê°’ì´ ì¡´ì¬í•˜ëŠ”ì§€ë¥¼ ê²€ì‚¬í•˜ê¸° ìœ„í•œ ê²€ìƒ‰ ì¡°ê±´

<br>

### ì• ê·¸ë¦¬ê±°íŠ¸ë¥¼ íŒ©í† ë¦¬ë¡œ ì‚¬ìš©í•˜ê¸°
* ê³ ê°ì´ íŠ¹ì • ìƒì ì„ ì—¬ëŸ¬ ì°¨ë¡€ ì‹ ê³ í•´ì„œ í•´ë‹¹ ìƒì ì´ ë” ì´ìƒ ë¬¼ê±´ì„ ë“±ë¡í•˜ì§€ ëª»í•˜ë„ë¡ ì°¨ë‹¨í•œ ìƒíƒœ
  * ìƒì  ê³„ì •ì´ ì°¨ë‹¨ ìƒíƒœê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ìƒí’ˆì„ ìƒì„±í•˜ë„ë¡ êµ¬í˜„ ê°€ëŠ¥

<br>

### ì• ê·¸ë¦¬ê±°íŠ¸ë¥¼ íŒ©í† ë¦¬ë¡œ ì‚¬ìš©í•˜ê¸° Example (1) BAD ğŸ‘
```java
public class RegisterProductService {

    public ProductId registerNewProduct(NewProductRequest req) {
        Store store = storeRepository.findById(req.getStoreId());
        checkNull(store);
        
        if (store.isBlocked()) {
            throw new StoredBlockedException();
        }
        
        ProductId id      = productRepository.nextId());
        Product   product = new Product(id, store.getId(), ...);
        productRepository.save(product();
        
        return id;
    }
}
```
* ë¬¸ì œì 
  * `RegisterProductService`, ì¦‰ ì‘ìš© ì„œë¹„ìŠ¤ì— ì¤‘ìš”í•œ ë„ë©”ì¸ ë¡œì§ ì²˜ë¦¬ê°€ ë…¸ì¶œë˜ëŠ” ë¬¸ì œ ë°œìƒ
  * `Storeê°€ Productë¥¼ ìƒì„±í•  ìˆ˜ ìˆëŠ”ì§€ íŒë‹¨í•˜ê³ , Productë¥¼ ìƒì„±í•˜ëŠ” ê²ƒ`ì€ ë…¼ë¦¬ì ìœ¼ë¡œ í•˜ë‚˜ì˜ ë„ë©”ì¸ ê¸°ëŠ¥ì„ --> ë…¸ì¶œë  í•„ìš” X

<br>

### ì• ê·¸ë¦¬ê±°íŠ¸ë¥¼ íŒ©í† ë¦¬ë¡œ ì‚¬ìš©í•˜ê¸° Example (ì• ê·¸ë¦¬ê±°íŠ¸ íŒ©í† ë¦¬ ë©”ì†Œë“œ - `createProduct`) GOOD ğŸ‘
```java
public class Store {
    
    public Product createProduct(ProductId newProductId, ...) {
        if (isBlocked())
            throw new StoreBlockdException();
        
        return new Product(newProductId, getId(), ...);
    }
}

public class RegisterProductService {
    
    public ProductId registerNewProduct(NewProductRequest req) {
        Store store = storeRepository.findById(req.getStoreId());
        checkNull(store);
        
        ProductId id      = productRepository.nextId();
        Product   product = store.createProduct(id, ...);

        productRepositry.save(product);
        return id;
    }
}
```
* ë³€ê²½ ë° ë°°í¬í•  ë•Œë„ ë„ë©”ì¸ ì˜ì—­ì˜ Storeë§Œ ì˜í–¥ ë°œìƒ
  * ë„ë©”ì¸ì˜ ì‘ì§‘ë„ ìƒìŠ¹
  * ì‘ìš©ì„œë¹„ìŠ¤ëŠ” ì˜í–¥ë„ X - `store.createProduct(id, ...);`ë§Œ ì•ˆë‹¤
* ProductëŠ” Storeì˜ ì‹ë³„ìê°€ í•„ìš”í•œ ìƒíƒœ
  * Storeì˜ ì‹ë³„ìì²˜ëŸ¼ ë‹¤ë¥¸ ì• ê·¸ë¦¬ê±°íŠ¸ì—ì„œ í•„ìš”í•œ ë°ì´í„°ê°€ ìˆë‹¤ë©´, Store ì• ê·¸ë¦¬ê±°íŠ¸ì—ì„œ Product ì• ê·¸ë¦¬ê±°íŠ¸ë¥¼ `íŒ©í† ë¦¬ ë©”ì†Œë“œ`ë¥¼ í†µí•´ ìƒì„± ê°€ëŠ¥

<br>
<hr>
<br>
