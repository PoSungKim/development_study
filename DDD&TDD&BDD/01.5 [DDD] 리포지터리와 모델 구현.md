# 리포지터리와 모델 구현
> 
* 

<hr>
<br>

## JPA를 이용한 리포지터리 구현
#### 애그리거트를 어떤 저장소에 저장하느냐에 따라 리포지터리를 구현하는 방법이 다르며, 현 책에서는 JPA 사용

<br>

### 모듈 위치
* Domain Layer
  * Model
  * `<<interface>>` ModelRepository
* Infra Layer
  * JpaModelRepository

<br>

### 리포지터리 기본 기능 구현
* 기본 제공 기능
  * ID로 애그리거트 조회하기
  * 애그리거트 저장하기 

```java
public interface OrderRepository {
    Order findById(OrderNo no);
    void  save(Order order);
}
```
* `Order findById(OrderNo no);`
  * 있으면, Order; otherwise, null;
* `Optional<Order> findById(OrderNo no);`
  * 있으면, Order; otherwise, `정의한 특정 객체`;

<br>

### JPA와 스프링을 이용한 리포지토리 구현
```java
@Repository
public class JpaOrderRepository implements OrderRepository {
    
    @PersistenceContext
    private EntityManager entityManager;
    
    @Override
    public Order findById(OrderNo id) {
        return entityManager.find(Order.class, id);
    }
    
    @Override
    public void save(Order order) {
        entityManager.persist(order);
    }
}
```
* @PersistenceContext
  * 영속성 컨텍스트를 주입하는 표준 애노테이션
    * @Autowired가 스프링에서 제공하는 기능
    * @PersistenceContext는 JPA 스펙에서 제공하는 기능
* 스프링 데이터 JPA를 사용하면 EntityManager를 통한 직접 구현이 필요없긴 하다
  * 자동으로 해주니까

```java
public class ChangeOrderService {

    @Transactional
    public void changeShippingInfo(OrderNo no, ShippingInfo newShippingInfo) {
        Optional<Order> orderOpt = orderRepository.findById(no);
        Order order = orderOpt.orElseThrow( () -> new OrderNotFoundException() );
        order.changeShippingInfo(newShippingInfo);
    }
}
```

<br>

```java
public interface OrderRepository {
    List<Order> findByOrdererId(String ordererId, int startRow, int size);
}
```

<br>

### JPQL을 이용한 findByOrdererId 메서드 구현

```java
@Override
public List<Order> findByOrdererId(String ordererId, int startRow, int fetchSize) {
    TypedQuery<Order> query = entityManager.createQuery(
        "select o from Order o " +
            "where o.orderer.memberId.id = :ordererId " +
            "order by o.number.number desc ",
        Order.class);
    
    query.setParameter("ordererId", ordererId);
    query.setFirstResult(startRow);
    query.setMaxResults(fetchSize);
    
    return query.getResultList();
    );
}
```

<br>

```java
public interface OrderRepository {
    public void delete(Order order);
}
```

<br>

### JPA를 이용한 리포지터리 삭제 기능 구현
```java
public class JpaOrderRepository implements OrderRepository {
    
    @PersistenceContext
    private EntityManager entityManager;
    
    @Override
    public void delete(Order order) {
        entityManager.remove(order);
    }
}
```
* 삭제 기능
  * 실제로 삭제하기 보다는 원복 등의 이유로 인해 flag 값을 넣어서 변경하는 형태로 많이 `삭제 처리`를 많이 한다

<br>
<hr>
<br>

## 스프링 데이터 JPA를 이용한 리포지터리 구현
#### Spring + JPA = Spring Data JPA, 즉 규칙에 맞게 Repository Interface를 정의하면 구현체를 알아서 Bean으로 등록해줌

<br>

### Repository Interface 정의 규칙
* org.springframework.data.repository.Repository<T, ID> 인터페이스 상속
* T는 엔티티 타입을 지정하고 ID는 식별자 타입을 지정

```java
@Entity
@Table(name = "purchase_order")
@Access(AccessType.FIELD)
public class Order {
    @EmbeddedId
    private OrderNo number; // OrderNo가 식별자 타입
}
```

```java
public interface OrderRepository extends Repository<Order, OrderNo> {
    Optional<Order> findById(OrderNo id);
    
    void save(Order order);
}
```

```java
@Service
public class CancelOrderService {
    private OrderRepository orderRepository;
    
    public CancelOrderService(OrderRepository orderRepository, ...) {
        this.orderRepository = orderRepository;
    }
    
    @Transactional
    public void cancel(OrderNo orderNo, Canceller canceller) {
        Order order = orderRepository.findById(orderNo);
                                     .orElseThrow( () -> new NoOrderException() );
        if ( !cancelPolicy.hasCancellationPermission(order, canceller) ) {
            throw new NoCancellablePermission();
        }
        
        order.cancel();
        
    }
}
```

<br>

### save()
```java
Order save(Order entity)
void  save(Order entity)
```

<br>

### findById()
```java
Order           findById(OrderNo id)
Optional<Order> findById(OrderNo id)
```

<br>

### findBy프로퍼티이름(프로퍼티 값)
```java
List<Order> findByOrderer(Orderer orderer)
```

<br>

### findBy중첩프로퍼티이름(프로퍼티 값)
```java
List<Order> findByOrdererMemberId(MemberId memberId)
```
* Orderer 객체의 memberId 프로퍼티

<br>

### delete()
```java
void delete(Order order)
void deleteById(OrderNo id)
```
* 식별자로 삭제

<br>
<hr>
<br>

## 엔티티와 밸류 매핑
#### 

<br>

### 

<br>
<hr>
<br>

## 매핑 구현 
#### 밸류 컬렉션 매핑

<br>

### 엔티티와 밸류 기본 매핑 구현
* 

<br>
<hr>
<br>

## 애그리거트 로딩 전략과 영속성 전파
#### 

<br>

### 

<br>
<hr>
<br>

## 식별자 생성 기능
#### 

<br>

### 
