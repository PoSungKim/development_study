# 조인 튜닝
> 
* 

<hr>
<br>

## NL 조인
#### 

<br>

### ordered vs leading
* ordered use_nl(c) use_hash(t)
* leading(o c t) use_nl(c) use_hash(t)

<br>

### ordered use_nl(c) index(e) index(c)
* NL 조인 데이터 엑세스 순서
  * index - table - index - table
* 
  ```sql
  select /*+ ordered use_nl(c) index(e) index(c) */
      ...
  from 사원 e, 고객 c
  where 1=1
  and e.관리사원번호 = c.사원번호
  and e.입사일자 >= '19960101'
  and e.부서코드 = 'Z123'
  and c.최종주문금액 >= 20000
  ```

<br>

### NL 조인 특징
* 랜덤 액세스 위주의 조인 방식
  * 인덱스 구성이 완벽에 가까워도 대량 데이터를 조인할 때는 NL 조인이 불리하다
* 조인할 대상 레코드가 많아도 ArraySize에 해당하는 최초 N건을 빠르게 출력할 수 있다
  * 조인을 한 레코드씩 순차적으로 진행한다
    * 순차적으로 진행하기 때문에 부분범위 처리가 가능하면 빠른 응답 속도를 낼 수 있다
  * 먼저 액세스되는 테이블 처리 범위에 따라 전체 일량이 결정된다
* 인덱스 유무, 인덱스 구성에 의해 성능이 크게 달라진다
* 따라서, 소량 데이터 위주의 처리 혹은 부분범위 처리가 가능한 온라인 트랜잭션 처리 (OLTP) 시스템에 적합한 조인 방식

<br>

### 인덱스 칼럼 튜닝
* 한 달 간 거래 건수 : 평균 20만 건
  ```sql
  select .*
  from   상품 p, 거래 t
  where  p.상품분류코드 = 'KTG'
  and    p.상품가격 between 100000 and 200000
  and    t.상품코드 = p.상품코드
  and    t.거래일자 between '20210101' and '20210131';
  ```
  ```
  Rows     Row Source Operation                  
  ------   ----------------------------------------------------------------------------
     368   NESTED LOOPS
      69     TABLE ACCESS BY INDEX ROWID 상품
    9185       INDEX RANGE SCAN 상품_X01
     368     TABLE ACCESS BY INDEX ROWID 거래
     385       INDEX RANGE SCAN 거래_X02
  ```
* 튜닝 방안
  * (1) 조인 순서 변경 : 한 달 거래 건수가 평균 20만 건이기 때문에 효과가 미흡
  * (2) 상품_X01 인덱스 칼럼 순서 조정 : Index Range Scan 결과 Rows 수는 순서 조정과는 무관해서 효과가 미흡
  * (3) 상품_X01 인덱스 칼럼 추가 : Table Access By Index Rowid까지 했을 때 Rows 수가 감소하는 것을 보면, 상품_X01 인덱스는 단일 칼럼으로 되어 있는 경우로 추정됨; 따라서, 테이블에서 필터링 조건으로 사용됐을 칼럼을 인덱스에 추가하면 Table Random Access에 사용되는 Rows들이 감소할 예정
  * (4) 거래_X02 인덱스 칼럼 추가 : 인덱스 엑세스 후 결과 Rows 개수와 테이블 액세스 후 결과 Rows 개수의 차이가 17밖에 나지 않기 때문에 칼럼 추가의 효과는 미흡

<br>
<hr>
<br>
