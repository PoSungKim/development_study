# 병렬 처리
> SQL문이 수행해야 하는 작업 범위를 여러 개의 작은 단위로 나누어 여러 프로세스 (또는 쓰레드)가 동시에 처리하는 것을 말한다
* 

<hr>
<br>

## 기본 개념
#### 

<br>

<div align="center">
  <img width="80%"  src="https://github.com/PoSungKim/development_study/assets/37537227/be72781b-6c5b-4b01-b74f-52b3e7985e00">
</div>

### (1) Query Coordinator와 병렬 서버 프로세스
* Query Coordinator (QC)는 병렬 SQL문을 발행한 사용자 세션 자신 
* 병렬 서버 프로세스는 실제 작업을 수행하는 개별 세션들
```sql
select /*+ ordered use_hash(d) full(d) full(e) nonparallel(d) parallel(e 4) */
       count(*), min(sal), max(sal), avg(sal), sum(sal)
from   dept d, emp e
where  d.loc = 'CHICAGO'
and    e.deptno = d.deptno;
```
```
Id     Operation                             Name      TQ        IN-OUT    PQ Distrib      
----   -----------------------------------   -------   -------   -------   -----------
0      SELECT STATEMENT
1        SORT AGGREGATE
2          PX COORDINATOR
3            PX SEND QC (RANDOM)             :TQ10002  Q1,02     P->S      QC (RAND)
4              SORT AGGREGATE                          Q1,02     PCWP
5                HASH JOIN                             Q1,02
6                  BUFFER SORT                         Q1,02
7                    PX RECEIVE                        Q1,02
8                      PX SEND HASH          :TQ10000            S->P      HASH
9                        TABLE ACCESS FULL   DEPT
10               PX RECEIVE                            Q1,02     PCWP
11                 PX SEND HASH              :TQ10001  Q1,01     P->P      HASH
12                    PX BLOCK ITERATOR                Q1,01     PCWP
13                      TABLE ACCESS FULL    EMP       Q1,01     PCWP
```

<br>

### (2) Intra-Operation Parallelism과 Inter-Operation Parallelism
```sql
select /*+ full(고객) parallel(고객 4) */ *
from   고객
order by 고객명;
```

<div align="center">
  <img width="80%"  src="https://github.com/PoSungKim/development_study/assets/37537227/ff867a56-a3fe-4f17-984c-459c04cdcf76">
</div>

* 병렬서버집합 1 : 배분 역할
* 병렬서버집합 2 : 정렬 역할
* QC : 머지 (merge) 역할

<br>

### (3) 테이블 큐
* 테이블 큐
  * 쿼리 서버 집합 간 (P->P) 또는 QC와 쿼리 서버 집합 간 (P->S,S->P) 데이터 전송을 위해 연결된 파이프 라인
* 테이블 큐 식별자 (TQ Identifier)
  * ex) :TQ10000, :TQ10001, :TQ10002

```sql
select /*+ ordered use_hash(e) full(d) noparallel(d) full(e) parallel(e 2) pq_distribute(e broadcast none) */ *
from   dept d, emp e
where  d.deptno = e.deptno
order by e.ename;
```

<div align="center">
  <img width="80%"  src="https://github.com/PoSungKim/development_study/assets/37537227/4da29bdf-cf9e-45f0-808b-49256122a118">
</div>

* 그림 해설
  * 필요 서버 프로세스 개수 : 병렬도 * 2
  * P->P 필요 파이프라인 개수 : 병렬도 ^ 2
* 생산자/소비자 모델
  * 테이블 큐 마다 생산자 (Producer)와 소비자 (Consumer)가 있다
  * Inter-Operation Parallelism 마다 소비자 서버 집합은 from에 테이블 큐를 참조하는 서브 (Sub) SQL 작업을 수행한다
* 병렬 실행계획에서 생산자와 소비자 식별
  * 생산자 : PX_SEND
  * 소비자 : PX_RECEIVE
  
  ```
  Id     Operation                             Name      TQ        IN-OUT    PQ Distrib      
  ----   -----------------------------------   -------   -------   -------   -----------
  0      SELECT STATEMENT
  1        PX COORDINATOR
  2          PX SEND QC (ORDER)                :TQ10002  Q1,02     P->S      QC (ORDER)
  3            SORT ORDER BY                             Q1,02     PCWP
  4              PX RECEIVE                              Q1,02     PCWP
  5                PX SEND RANGE               :TQ10001  Q1,02     P->P      RANGE
  6                  HASH JOIN                           Q1,01     PCWP
  7                    BUFFER SORT                       Q1,01     PCWC
  8                      PX RECEIVE                      Q1,01     PCWP 
  9                        PX SEND BROADCAST   :TQ10000            S->P      BROADCAST
  10                         TABLE ACCESS FULL DEPT      
  11                     PX BLOCK ITERATOR               Q1,01     PCWC
  12                       TABLE ACCESS FULL   EMP       Q1,Q1     PCWP      
  ```

<br>

### (4) IN-OUT 오퍼레이션 
* S->P : PARALLEL_FROM_SERIAL
* P->S : PARALLEL_TO_SERIAL
* P->P : PRARALLEL_TO_PARALLEL
* PCWP : PARALLEL_COMBINED_WITH_PARENT
* PCWC : PARALLEL_COMBINED_WITH_CHILD

<br>

### (5) 데이터 재분배
* RANGE
* HASH
* BROADCAST
* KEY
* ROUND-ROBIN

<br>
<hr>
<br>
