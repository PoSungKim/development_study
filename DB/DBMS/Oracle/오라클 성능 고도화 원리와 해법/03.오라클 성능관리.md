# 오라클 성능관리
> 실행결과 + 실행계획 + 실행통계
* SQL 튜닝
  * 문제점 확인
    * EXPLAIN PLAIN
    * AutoTrace 혹은 SQL 트레이스
  * 문제점 해결
    * 쿼리 변환 혹은 옵티마이저 힌트 
    * 인덱스 조정
    * 반정규화 혹은 집계 테이블 생성

<hr>
<br>

## Explain Plan
#### sys.plan_table, all_synonyms

<br>

### Explain Plan
* 오라클 10g부터는 sys.plan_table이 자동 생성된다
```sql
SELECT owner, synonym_name, table_owner, table_name
FROM   all_synonyms
WHERE  synonym_name = 'PLAN_TABLE';
```

* SQL 수행하기 전에 실행계획 확인고자 할 때, EXPLAIN PLAN 명령어 사용
```sql
EXPLAIN PLAN SET statement_id = 'query1' FOR
SELECT * FROM emp WHERE empno = 7900;
```

<br>
<hr>
<br>

## AutoTrace
#### SQL 튜닝을 위한 유용한 정보를 제공하는 도구

<br>

### AutoTrace
```sql
SET AUTOTRACE ON

SELECT * FROM emp WHERE empno = 7900;
```
* 명령어 결과 구성
  * 쿼리수행결과
  * 실행계획
  * 실행통계
* 통계 칼럼
  * recursive calls
  * db block gets
  * consistent gets
  * physical gets
  * redo size
  * bytes sent via SQL*Net to client
  * bytes received via SQL*Net from client
  * SQL*Net roundtrips to /from client
  * sorts (memory)
  * sorts (disk)
  * rows processed
* 명령어
  * set autotrace on
    * 실행결과 + 실행계획 + 실행통계
  * set autotrace on explain
    * 실행결과 + 실행계획
  * set autotrace on statistics
    * 실행결과 + 실행통계
  * set autotrace traceonly
    * 실행계획 + 실행통계
  * set autotrace traceonly explain
    * 실행계획
  * set autotrace traceonly statistics
    * 실행통계
* 실행결과
  * 쿼리 수행 필요 O
* 실행계획
  * 쿼리 수행 필요 X
* 실행통계
  * 쿼리 수행 필요 O
* 권환
  * 실행계획 : plan_table 
  * 실행통계 : v_$sesstat, v_$statname, v_$mystat
  
<br>
<hr>
<br>

## SQL 트레이스
#### SQL 튜닝에 가장많이 사용되는 도구
#### 사전 실행계획과 AutoTrace만으로는 부하원인을 찾을 수 없을 때, SQL 트레이스 사용하여 .trc 트레이스 파일을 생성한다

<br>

### 자기 세션에 트레이스 걸기 
```sql
ALTER SESSION SET sql_trace = true;

SELECT * FROM emp WHERE empno = 7900;
```
* TKProf 유틸리티 : 트레이스 파일을 읽기 쉽게 포맷팅해주는 유틸 (.trc > .prf)
  * Trace Kernel PROFile
  * Transient Kernel PROFile
  * ToolKit PROFiler
* 트레이스 결과 분석
  * Call 통계 칼럼
    * call : 커서 상태에 따라 나누어 통계정보를 보여준다
      * Parse : 커서를 파싱하고 실행계획을 생성하는 것에 대한 통계
      * Execute : 커서의 실행 단계에 대한 통계
      * Fetch : 레코드를 실제로 Fetch하는 것에 대한 통계
    * count : Parse, Execute, Fetch 각 단계가 수행된 횟수
    * cpu : 현재 커서가 각 단계에서 사용한 CPU Time
    * elapsed : 현재 커서가 각 단계를 수행하는 데 소요한 시간
    * disk : 디스크로부터 읽은 블록 수
    * query : Consistent 모드로 읽은 블록 수
    * current : Current 모드로 읽은 블록 수
    * rows : 각 단계에서 일거나 갱신한 처리 건수
* 이벤트 트레이스
  * 레벨 설정을 통해, 바인드 변수와 대기 이벤트 발생 현황을 로그에 기록하여 모니터링 가능
* Elapsed time = CPU time + Wait time
  * Response time - Call 시점
  * Call 횟수
    * SELECT 문 = Parse Call + Execute Call + Fetch Call
    * DML 문 = Parse Call + Execute Call
  * Fetch Call 횟수 = 1 + 전체 건수 / ArraySize
    * 예) 1 (one-row fetch) + 1000건 / ArraySize (100) = 11

<br>

### 
  
<br>
<hr>
<br>
