# 소트 튜닝
> SQL 튜닝에서 빠질 수 없는 요소가 소트 튜닝
* 소트 오퍼레이션은 수행과정에서 CPU와 메모리를 많이 사용하고, 데이터량이 많을 때는 디스크 I/O까지 발생한다
* OLTP 환경에서 애플리케이션 성능을 저하시키는 주요인으로 작용하기도 한다

<hr>
<br>

## 소트 수행 원리
#### 

<br>

### 소트 수행 과정
* SQL 수행 도중 데이터 정렬이 필요할 때면 오라클은 PGA 메모리에 Sort Area를 할당하는데, 그 안에서의 처리 완료 가능 여부에 따라 2가지 유형으로 나뉜다
  * 메모리 소트 (Memory Sort)
    * 전체 데이터의 정렬 작업을 메모리 내에서 완료하는 경우이며, Internal Sort로 불리기도 한다
  * 디스크 소트 (Disk Sort)
    * 할당받은 Sort Area 내에서 정렬을 완료하지 못해 디스크 공간까지 사용하는 경우이며, External Sort로 불리기도 한다

<div align="center">
  <img width="80%"  src="https://github.com/PoSungKim/development_study/assets/37537227/be8ac102-750d-48e5-83e5-c833158d423a" />
</div>

* Optimal 소트 : 소트 오퍼레이션이 메모리 내에서만 이루어짐
  * Sort Area 내에서 데이터 정렬을 마무리하는 경우 (최적)
* Onepass 소트 : 정렬 대상 집합이 디스크에 한 번만 쓰임
  * Sort Area가 각 Sort Run으로부터 하나의 청크(Chunk)씩 읽어 들일 정도의 크기라서 추가적인 디스크 I/O가 발생하는 경우
* Multipass 소트 : 정렬 대상 집합이 디스크에 여러 번 쓰임
  * Sort Run으로부터 읽은 데이터를 다시 디스크에 썼다가 읽어 들이는 과정을 여러 번 반복하는 경우

<br>

### 소트 오퍼레이션 측정
* 환경설정
  ```sql
  create table t_emp
  as
  select *
  from emp, (select rownum no from dual connect by level <= 100000);
  
  alter session set workarea_size_policy = manual;
  
  alter session set sort_area_size = 1048576;
  ```
* 소트 쿼리수행
  ```sql
  set autotrace on
  select *
  from   (
      select no, empno, ename, job, mgr, sal
           , avg(sal) over (partition by to_char(no), deptno) avg_sal
      from   t_emp
  )
  where no = 1
  order by sal desc;
  ```
* autotrace
  ```
  Id     Operation                             Name
  ----   -----------------------------------   --------------
  0      SELECT STATEMENT
  1        SORT ORDER BY
  2          VIEW                              EMP
  3            WINDOW SORT                     EMP_DEPTNO_IDX   
  4              TABLE ACCESS FULL             T_EMP
  
  Predicate Information (identified by operation id):
  -----------------------------------------------------
  2 - filter ("NO"=1)
  
  Statistics
  -----------------------------------------------------
    241   recursive calls
     90   db block gets
   9293   consistent gets
  33003   physical reads
      0   redo size
   1275   bytes sent via SQL*Net to client
    385   bytes received via SQL*Net from client
      2   SQL*Net roundtrips to/from client
      1   sorts (memory)
      1   sorts (disk)
     14   rows processed
  ```

<br>
<hr>
<br>
