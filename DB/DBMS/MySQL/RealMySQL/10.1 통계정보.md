# 통계 정보
> MySQL 5.7 버전까지 테이블과 인덱스에 대한 개괄적인 정보를 가지고 실행 계획 수립
* MySQL 8.0 버전부터는 인덱스되지 않은 칼럼들에 대해서도 데이터 분포도를 수집해서 저항하는 히스토그램(Histogram) 정보 도입

<hr>
<br>

## 테이블 및 인덱스 통계 정보
#### 비용 기반 최적화에서 가장 중요한 것은 통계 정보

<br>

### MySQL 서버의 통계 정보
```mysql
SHOW TABLES LIKE '%_stats';
```
* innodb_index_stats
* innodb_table_stats

```mysql
CREATE TABLE tab_test (fd1 INT, fd2 VARCHAR(20), PRIMARY KEY(fd1))
ENGINE=InnoDB
STATS_PERSISTENT={ DEFAULT | 0 | 1 }
```
* STATS_PERSISTENT
  * 0 : OFF (휘발성으로 메모리에 적재)
  * 1 : ON  (영속성으로 DB에 적재)
  * DEFAULT : innodb_stats_persistent 시스템 변수 값 (default : 1)
* 통계 정보 칼럼
  * innodb_index_stats
    * `n_diff_pfx%` : 인덱스가 가진 유니크한 값의 개수 
    * `n_leaf_pages` : 인덱스의 리프 노드 페이지 개수
    * `size` : 인덱스 트리의 전체 페이지 개수
  * innodb_table_stats
    * `n_rows` : 테이블의 전체 레코드 건수
    * `clusterred_index_size` : 프라이머리 키의 크기 (InnoDB 페이지 개수)
    * `sum_of_other_index_sizes` : 프라이머리 키를 제외한 인덱스의 크기(InnoDB 페이지 개수)
```mysql
ANALYZE TABLE employees.employees;
```
* MySQL 5.5까지는 메모리 vs MysQL 5.6부터는 DB (영구)
  * MySQL 5.5까지는 자동으로 통계 정보 갱신
    * 테이블이 새로 오픈되는 경우
    * 테이블의 레코드가 대량으로 변경되는 경우
    * ANALYZE TABLE 명령이 실행되는 경우
    * SHOW TABLE STATUS 명령이나 SHOW INDEX FROM 명령이 실행되는 경우
    * InnoDB 모니터가 활성화되는 경우
    * innodb_stats_on_metadata 시스템 설정이 ON인 상태에서 SHOW TABLE STATUS 명령이 실행되는 경우
  * `STATS_AUTO_RECALC`
    * 1 : MySQL 5.5 이전의 방식대로 자동 수집
    * 0 : ANALYZE TABLE 명령을 실행할 때만 수집
    * DEFAULT : `innodb_stats_auto_recalc` 시스템 설정 변수 값으로 설정
  * `innodb_stats_transient_sample_pages`
    * 자동으로 통계 정보 수집 실행될 때, 임의로 몇 개의 페이지를 샘플링해서 통계 정보를 갱신할지에 대한 설정
  * `innodb_stats_persistent_sample_pages`
    * ANLAYZE TABLE 명령이 실행될 때, 임의로 몇 개의 페이지를 샘플링해서 통계 정보를 갱신할지에 대한 설정

<br>

### 히스토그램
* 히스토그램 정보 수집 및 삭제 
  * 칼럼 단위로 관리되며, 수집된 히스토그램 정보는 시스템에 딕셔너리에 함께 저장되어, MySQL 서버가 시작될 때 딕셔너리의 히스토그램 정보를 information_schema 데이터베이스의 column_statistics 테이블로 로드
  ```mysql
  ANALYZE TABLE       employees.employees 
  UPDATE HISTOGRAM ON gender, hire_date
  ;
  
  SELECT *
  FROM   COLUMN_STATISTICS
  WHERE  SCHEMA_NAME='employees'
    AND  TABLE_NAME='employees' \G 
  ;
  ```
  * 히스토그램 2종류
    * Singleton (싱글톤 히스토그램) : 칼럼값 개별로 레코드 건수 관리
    * Equi-Height (높이 균형 히스토그램) : 칼럼값의 범위를 균등한 개수로 구분해서 관리

<br>
<hr>
<br>

## 
#### 

<br>

###

<br>
<hr>
<br>
